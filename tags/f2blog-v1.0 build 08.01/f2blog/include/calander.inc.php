<?php
$year=$_REQUEST['year'];
$month=$_REQUEST['month'];

if (strpos($_GET['seekname'],"|")>0){
	$arrSeekname=explode("|",$_GET['seekname']);
	$year=intval($arrSeekname[0]);
	$month=intval($arrSeekname[1]);
}

$curTime=time()+$settingInfo['timezone']*3600;
include_once("cache/cache_calendar.php");

function FormatMonth($time){
	$fmonth=intval(substr($time,0,strpos($time,"-")));
	$fday=intval(substr($time,strpos($time,"-")+1));
	if (strlen($fmonth)==1){$fmonth="0$fmonth";}
	if (strlen($fday)==1){$fday="0$fday";}
	$time="$fmonth$fday";
	return $time;
}

#检查浏览器类型
$browse=$_SERVER["HTTP_USER_AGENT"]; 
if (strpos($browse, "MSIE")>0) {
	$browvr="IE";
	$spacer="\n";
} else {
	$browvr="firfox";
	$spacer="&nbsp;";
}

#农历每月的天数
$everymonth=array(
0=>array(8,0,0,0,0,0,0,0,0,0,0,0,29,30,7,1),
1=>array(0,29,30,29,29,30,29,30,29,30,30,30,29,0,8,2),
2=>array(0,30,29,30,29,29,30,29,30,29,30,30,30,0,9,3),
3=>array(5,29,30,29,30,29,29,30,29,29,30,30,29,30,10,4),
4=>array(0,30,30,29,30,29,29,30,29,29,30,30,29,0,1,5),
5=>array(0,30,30,29,30,30,29,29,30,29,30,29,30,0,2,6),
6=>array(4,29,30,30,29,30,29,30,29,30,29,30,29,30,3,7),
7=>array(0,29,30,29,30,29,30,30,29,30,29,30,29,0,4,8),
8=>array(0,30,29,29,30,30,29,30,29,30,30,29,30,0,5,9),
9=>array(2,29,30,29,29,30,29,30,29,30,30,30,29,30,6,10),
10=>array(0,29,30,29,29,30,29,30,29,30,30,30,29,0,7,11),
11=>array(6,30,29,30,29,29,30,29,29,30,30,29,30,30,8,12),
12=>array(0,30,29,30,29,29,30,29,29,30,30,29,30,0,9,1),
13=>array(0,30,30,29,30,29,29,30,29,29,30,29,30,0,10,2),
14=>array(5,30,30,29,30,29,30,29,30,29,30,29,29,30,1,3),
15=>array(0,30,29,30,30,29,30,29,30,29,30,29,30,0,2,4),
16=>array(0,29,30,29,30,29,30,30,29,30,29,30,29,0,3,5),
17=>array(2,30,29,29,30,29,30,30,29,30,30,29,30,29,4,6),
18=>array(0,30,29,29,30,29,30,29,30,30,29,30,30,0,5,7),
19=>array(7,29,30,29,29,30,29,29,30,30,29,30,30,30,6,8),
20=>array(0,29,30,29,29,30,29,29,30,30,29,30,30,0,7,9),
21=>array(0,30,29,30,29,29,30,29,29,30,29,30,30,0,8,10),
22=>array(5,30,29,30,30,29,29,30,29,29,30,29,30,30,9,11),
23=>array(0,29,30,30,29,30,29,30,29,29,30,29,30,0,10,12),
24=>array(0,29,30,30,29,30,30,29,30,29,30,29,29,0,1,1),
25=>array(4,30,29,30,29,30,30,29,30,30,29,30,29,30,2,2),
26=>array(0,29,29,30,29,30,29,30,30,29,30,30,29,0,3,3),
27=>array(0,30,29,29,30,29,30,29,30,29,30,30,30,0,4,4),
28=>array(2,29,30,29,29,30,29,29,30,29,30,30,30,30,5,5),
29=>array(0,29,30,29,29,30,29,29,30,29,30,30,30,0,6,6),
30=>array(6,29,30,30,29,29,30,29,29,30,29,30,30,29,7,7),
31=>array(0,30,30,29,30,29,30,29,29,30,29,30,29,0,8,8),
32=>array(0,30,30,30,29,30,29,30,29,29,30,29,30,0,9,9),
33=>array(5,29,30,30,29,30,30,29,30,29,30,29,29,30,10,10),
34=>array(0,29,30,29,30,30,29,30,29,30,30,29,30,0,1,11),
35=>array(0,29,29,30,29,30,29,30,30,29,30,30,29,0,2,12),
36=>array(3,30,29,29,30,29,29,30,30,29,30,30,30,29,3,1),
37=>array(0,30,29,29,30,29,29,30,29,30,30,30,29,0,4,2),
38=>array(7,30,30,29,29,30,29,29,30,29,30,30,29,30,5,3),
39=>array(0,30,30,29,29,30,29,29,30,29,30,29,30,0,6,4),
40=>array(0,30,30,29,30,29,30,29,29,30,29,30,29,0,7,5),
41=>array(6,30,30,29,30,30,29,30,29,29,30,29,30,29,8,6),
42=>array(0,30,29,30,30,29,30,29,30,29,30,29,30,0,9,7),
43=>array(0,29,30,29,30,29,30,30,29,30,29,30,29,0,10,8),
44=>array(4,30,29,30,29,30,29,30,29,30,30,29,30,30,1,9),
45=>array(0,29,29,30,29,29,30,29,30,30,30,29,30,0,2,10),
46=>array(0,30,29,29,30,29,29,30,29,30,30,29,30,0,3,11),
47=>array(2,30,30,29,29,30,29,29,30,29,30,29,30,30,4,12),
48=>array(0,30,29,30,29,30,29,29,30,29,30,29,30,0,5,1),
49=>array(7,30,29,30,30,29,30,29,29,30,29,30,29,30,6,2),
50=>array(0,29,30,30,29,30,30,29,29,30,29,30,29,0,7,3),
51=>array(0,30,29,30,30,29,30,29,30,29,30,29,30,0,8,4),
52=>array(5,29,30,29,30,29,30,29,30,30,29,30,29,30,9,5),
53=>array(0,29,30,29,29,30,30,29,30,30,29,30,29,0,10,6),
54=>array(0,30,29,30,29,29,30,29,30,30,29,30,30,0,1,7),
55=>array(3,29,30,29,30,29,29,30,29,30,29,30,30,30,2,8),
56=>array(0,29,30,29,30,29,29,30,29,30,29,30,30,0,3,9),
57=>array(8,30,29,30,29,30,29,29,30,29,30,29,30,29,4,10),
58=>array(0,30,30,30,29,30,29,29,30,29,30,29,30,0,5,11),
59=>array(0,29,30,30,29,30,29,30,29,30,29,30,29,0,6,12),
60=>array(6,30,29,30,29,30,30,29,30,29,30,29,30,29,7,1),
61=>array(0,30,29,30,29,30,29,30,30,29,30,29,30,0,8,2),
62=>array(0,29,30,29,29,30,29,30,30,29,30,30,29,0,9,3),
63=>array(4,30,29,30,29,29,30,29,30,29,30,30,30,29,10,4),
64=>array(0,30,29,30,29,29,30,29,30,29,30,30,30,0,1,5),
65=>array(0,29,30,29,30,29,29,30,29,29,30,30,29,0,2,6),
66=>array(3,30,30,30,29,30,29,29,30,29,29,30,30,29,3,7),
67=>array(0,30,30,29,30,30,29,29,30,29,30,29,30,0,4,8),
68=>array(7,29,30,29,30,30,29,30,29,30,29,30,29,30,5,9),
69=>array(0,29,30,29,30,29,30,30,29,30,29,30,29,0,6,10),
70=>array(0,30,29,29,30,29,30,30,29,30,30,29,30,0,7,11),
71=>array(5,29,30,29,29,30,29,30,29,30,30,30,29,30,8,12),
72=>array(0,29,30,29,29,30,29,30,29,30,30,29,30,0,9,1),
73=>array(0,30,29,30,29,29,30,29,29,30,30,29,30,0,10,2),
74=>array(4,30,30,29,30,29,29,30,29,29,30,30,29,30,1,3),
75=>array(0,30,30,29,30,29,29,30,29,29,30,29,30,0,2,4),
76=>array(8,30,30,29,30,29,30,29,30,29,29,30,29,30,3,5),
77=>array(0,30,29,30,30,29,30,29,30,29,30,29,29,0,4,6),
78=>array(0,30,29,30,30,29,30,30,29,30,29,30,29,0,5,7),
79=>array(6,30,29,29,30,29,30,30,29,30,30,29,30,29,6,8),
80=>array(0,30,29,29,30,29,30,29,30,30,29,30,30,0,7,9),
81=>array(0,29,30,29,29,30,29,29,30,30,29,30,30,0,8,10),
82=>array(4,30,29,30,29,29,30,29,29,30,29,30,30,30,9,11),
83=>array(0,30,29,30,29,29,30,29,29,30,29,30,30,0,10,12),
84=>array(10,30,29,30,30,29,29,30,29,29,30,29,30,30,1,1),
85=>array(0,29,30,30,29,30,29,30,29,29,30,29,30,0,2,2),
86=>array(0,29,30,30,29,30,30,29,30,29,30,29,29,0,3,3),
87=>array(6,30,29,30,29,30,30,29,30,30,29,30,29,29,4,4),
88=>array(0,30,29,30,29,30,29,30,30,29,30,30,29,0,5,5),
89=>array(0,30,29,29,30,29,29,30,30,29,30,30,30,0,6,6),
90=>array(5,29,30,29,29,30,29,29,30,29,30,30,30,30,7,7),
91=>array(0,29,30,29,29,30,29,29,30,29,30,30,30,0,8,8),
92=>array(0,29,30,30,29,29,30,29,29,30,29,30,30,0,9,9),
93=>array(3,29,30,30,29,30,29,30,29,29,30,29,30,29,10,10),
94=>array(0,30,30,30,29,30,29,30,29,29,30,29,30,0,1,11),
95=>array(8,29,30,30,29,30,29,30,30,29,29,30,29,30,2,12),
96=>array(0,29,30,29,30,30,29,30,29,30,30,29,29,0,3,1),
97=>array(0,30,29,30,29,30,29,30,30,29,30,30,29,0,4,2),
98=>array(5,30,29,29,30,29,29,30,30,29,30,30,29,30,5,3),
99=>array(0,30,29,29,30,29,29,30,29,30,30,30,29,0,6,4),
100=>array(0,30,30,29,29,30,29,29,30,29,30,30,29,0,7,5),
101=>array(4,30,30,29,30,29,30,29,29,30,29,30,29,30,8,6),
102=>array(0,30,30,29,30,29,30,29,29,30,29,30,29,0,9,7),
103=>array(0,30,30,29,30,30,29,30,29,29,30,29,30,0,10,8),
104=>array(2,29,30,29,30,30,29,30,29,30,29,30,29,30,1,9),
105=>array(0,29,30,29,30,29,30,30,29,30,29,30,29,0,2,10),
106=>array(7,30,29,30,29,30,29,30,29,30,30,29,30,30,3,11),
107=>array(0,29,29,30,29,29,30,29,30,30,30,29,30,0,4,12),
108=>array(0,30,29,29,30,29,29,30,29,30,30,29,30,0,5,1),
109=>array(5,30,30,29,29,30,29,29,30,29,30,29,30,30,6,2),
110=>array(0,30,29,30,29,30,29,29,30,29,30,29,30,0,7,3),
111=>array(0,30,29,30,30,29,30,29,29,30,29,30,29,0,8,4),
112=>array(4,30,29,30,30,29,30,29,30,29,30,29,30,29,9,5),
113=>array(0,30,29,30,29,30,30,29,30,29,30,29,30,0,10,6),
114=>array(9,29,30,29,30,29,30,29,30,30,29,30,29,30,1,7),
115=>array(0,29,30,29,29,30,29,30,30,30,29,30,29,0,2,8),
116=>array(0,30,29,30,29,29,30,29,30,30,29,30,30,0,3,9),
117=>array(6,29,30,29,30,29,29,30,29,30,29,30,30,30,4,10),
118=>array(0,29,30,29,30,29,29,30,29,30,29,30,30,0,5,11),
119=>array(0,30,29,30,29,30,29,29,30,29,29,30,30,0,6,12),
120=>array(4,29,30,30,30,29,30,29,29,30,29,30,29,30,7,1)
);
			   
//假期节日
$mholiday = array("0101","0123","0214","0308","0401","0405","0501","0512","0520","0701","1001","1031","1112","1224","1225","1226");

$holiday = array("0101","0102","0103","0104","0105","0115","0202","0323","0505","0701","0707","0815","0816","0909");
	
##############################
#赋给初值
#星期
$week=5;
#农历日
$md=0;
#农历月
$mm=0;
#阳历总天数 至1900年12月21日
$total=11;
#阴历总天数
$mtotal=0;
##############################

#如果没有输入，设为当日日期
if ($year=="" or $month=="" or ($year<1901 or $year>2020) or ($month<1 or $month>12)){
     $year=gmdate("Y",$curTime);
     $month=gmdate("n",$curTime);
}

##############################
#计算到所求日期阳历的总天数-自1900年12月21日始
#先算年的和
for ($y=1901;$y<$year;$y++){
	$total+=365;
	if ($y%4==0) $total ++;
}
#再加当年的几个月
switch ($month){
     case 12:
           $total+=30;
     case 11:
	       $total+=31;
     case 10:
           $total+=30;
     case 9:
           $total+=31;
     case 8:
           $total+=31;
     case 7:
           $total+=30;
     case 6:
           $total+=31;
     case 5:
           $total+=30;
     case 4:
           $total+=31;
     case 3:
           $total+=28;
     case 2:
           $total+=31;
}

#如果当年是闰年还要加一天
if ($year%4==0 and $month>2){
     $total++;
}

#顺便算出当月1日星期几
$week=($total+$week)%7;
##############################
#用农历的天数累加来判断是否超过阳历的天数
$flag1=0;#判断跳出循环的条件
$j=0;
while ($j<=120){
      $i=1;
      while ($i<=13){
            $mtotal+=$everymonth[$j][$i];
            if ($mtotal>=$total){
                 $flag1=1;
                 break;
               }
            $i++;
      }
	  if ($flag1==1) break;
      $j++;
}

##############################
#计算所求月份1号的农历日期
$md=$everymonth[$j][$i]-($mtotal-$total);
#月头空开的天数
$k=$week;

#是否跨越一年
switch ($month){
         case 1:
         case 3:
         case 5:
         case 7:
         case 8:
         case 10:
         case 12:
              $dd=31;
              break;
         case 4:
         case 6:
         case 9:
         case 11:
              $dd=30;
              break;
         case 2:
              if ($year%4==0){
                  $dd=29;
              }else{
                  $dd=28;
              }
         break;
}

#打印上一月，下一月
$pyear=$year-1;
$nyear=$year+1;

$ly=$ny=$year;
$last=$month-1;
if ($last==0){
     $last=12;
     $ly--;
}
$next=$month+1;
if ($next==13){
     $next=1;
     $ny++;
}

?>
<div id="Calendar_Top">
  <div id="LeftB" onclick="location.href='<?=$PHP_SELF."?year=$ly&month=$last"?>'"></div>
  <div id="RightB" onclick="location.href='<?=$PHP_SELF."?year=$ny&month=$next"?>'"></div>
  <?="$year $strYear  $month $strMonth"?> 
</div>
<div id="Calendar_week">
  <ul class="Week_UL">
    <li><font color="#ff0000"><?=$arrWeek[0]?></font></li>
    <li><?=$arrWeek[1]?></li>
    <li><?=$arrWeek[2]?></li>
    <li><?=$arrWeek[3]?></li>
    <li><?=$arrWeek[4]?></li>
    <li><?=$arrWeek[5]?></li>
    <li><?=$arrWeek[6]?></li>
  </ul>
</div>
<?php
	$day=1;
	$line=0;
	while ($day<=$dd){
	   echo "<div class=\"Calendar_Day\">\n<ul class=\"Day_UL\">\n";
	   for ($s=0;$s<=6;$s++){
			 if ($k<>0 or $day>$dd){
				  echo "<li class=\"DayA\">$spacer</li>";
				  $k--;
			 }else{
				   switch ($s){
                        case 1:
                        case 2:
                        case 3:
                        case 4:
                        case 5:
                             $color="black";
                             break;
                        case 0:
                             $color="red";
                             break;
                        case 6:
                             $color="red";
                             break;
                   }
				
				//if ($browvr=="IE") {
					#生成中文农历
				   if ($md==1){  //1日打印月份
						if ($everymonth[$j][0]<>0 and $everymonth[$j][0]<$i){
							$mm=$i-1;
						}else{
							$mm=$i;
						}
						if ($i==$everymonth[$j][0]+1 and $everymonth[$j][0]<>0) $chi=$mmonth[0].$mmonth[$mm];  //月
						else $chi=$mmonth[$mm].$mmonth[13];
				   }else{
						$chi=$mday[$md];
				   }
			   
				   $scday=$month."-".$day;
				   $mcday=$i."-".$md;
				   $scday=FormatMonth($scday);
				   $mcday=FormatMonth($mcday);
				   $color1="#999999";

				   for ($th=0;$th<15;$th++) {
						if ($mholiday[$th]==$scday) {
							$chi=$mholiday1[$th];
							$color1="red";
							$color="red";
							break;
						}
				   }

				   for ($th=0;$th<15;$th++) {
						if ($holiday[$th]==$mcday) {
							$chi=$holiday1[$th];
							$color1="red";
							$color="red";
							break;
						}
				   }
				//}

				   $currdate=$year."-".$month."-".$day;
				   $currdate_hy=gmdate("Y-n-j",$curTime);
				   $class=($currdate==$currdate_hy)?"class=\"today\"":"";
				   $calss=($calendarcache[$currdate]!="")?"class=\"haveD\"":$class;
				   if ($calendarcache[$currdate]!="") {
						$class="class=\"haveD\"";
						$curF2Day=$year."|".$month."|".$day;
						$href=" href=\"index.php?job=calendar&seekname=$curF2Day\" ";
						$strDayLog=str_replace("1",$calendarcache[$currdate],$strDayLogs);
						$atitle=" title=\"$strDayLog\" ";
				   } else {
						$href="";
						$atitle="";
				   }

					//style=\"color:$color\" 
				   echo "<li class=\"DayA\"><a $class$href$atitle>$day";
				   echo "<br> <span style=\"font-size:9px;color:$color1\" title=\"$chi\">".subString($chi,0,2)."</span>";;
				   echo "</a></li>\n";
				
					//下一天
				   $day++;
				   $md++;
				   if ($md>$everymonth[$j][$i]){
						$md=1;
						$i++;
				   }
				   if (($i>12 and $everymonth[$j][0]==0) or ($i>13 and $everymonth[$j][0]<>0)){
						 $i=1;
						 $j++;
				   }
           }
       }
   echo "</ul>\n</div>\n";
   $line++;
}
?>
